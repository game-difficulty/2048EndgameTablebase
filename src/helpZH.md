
# 用户手册

**作者**：game_difficulty  
**版本**：7.4  
**日期**：2025.7.4  

---

# 1、概述

这是一个多功能的 2048 游戏训练软件，提供包括残局库计算、残局训练、对局分析、AI 训练、改版小游戏等丰富功能。

## 1.1 亮点
- **计算快速**：采用高度优化的算法，提供极快的计算速度。
- **空间占用低**：采用多种数据压缩技术，大幅减少软件的磁盘空间占用。
- **最强的 AI**：内置最强的 2048 游戏 AI，65536成功率远超目前其他AI。
- **功能完善**：提供完整的训练和分析工具，帮助用户深入学习游戏策略。

## 1.2 目标用户
- **专业玩家**：需要更强大工具来研究游戏技巧和策略的玩家。
- **AI 开发者**：希望利用游戏数据训练和优化 AI 的开发者。
- **普通玩家**：希望体验改版小游戏或借助AI提高分数的玩家。

---

# 2、安装与启动

## 2.1 系统要求
- **操作系统**：Windows 7 及以上版本。
- **内存**：至少 4GB ，越大越好，建议开启虚拟内存。
- **磁盘空间**：磁盘空间越大越好，建议SSD有 10GB 以上的剩余空间。
- **CPU**：支持 AVX-512 指令集的 CPU 可以获得更好的性能。
- **GPU**：软件不依赖GPU。

## 2.2 安装步骤
- **解压**：下载并解压软件压缩包。
- **运行**：在解压后的文件夹中找到 `main.exe` 文件，双击运行即可启动软件。

## 2.3 启动说明
- **启动**：每次启动时，初次使用某些功能可能需要较长的初始化时间，请耐心等待。
- **错误排查**：如果软件无法启动或出现异常，请首先查看 `logger.txt` 文件，可能包含启动失败的详细信息或错误日志。

---

# 3、概念介绍

## 3.1 什么是残局

游戏进行到某一局面时，特定格子内已排列好若干大数字，玩家需要利用剩余的格子拼凑出目标数字，使游戏进入新的阶段。**残局是从特定局面开始到合成目标数字的整个过程。**

## 3.2 残局的分类

**根据剩余格子数和残局难度分类。**

例如，10格16k残局（10格16384残局），是指局面中已有大数8k、4k、2k、1k、512、256，占用了6个格子。此时，剩余的10个格子需要拼出一个256，而这是“16k难度”的。

类似地，12格32k残局（12格32768残局）表示局面中已有大数16k、8k、4k、2k，剩余的12个格子用来拼出2048，最终达成32768。

进一步地，如果局面已存在32k、16k、4k、2k，玩家也只需要用12个空位拼出2048，同样视为12格32k残局，因为这一过程与新合成一个32768难度相当。

因此，残局的分类与局面上已存在的大数究竟是哪些无关，只与其数量有关。

问：9格65k残局的目标数字是？

## 3.3 什么是定式

**定式是附加了限制条件的残局。**

在游戏中，一般情况下应尽可能保持大数字不移动，同时为了保证后续合并或维持阵型，目标数字必须在某些位置合成。
所以，限制条件一般包括:

- 要求初始局面中的大数字始终保持在原位或者只能有限制地移动。
- 要求最终在指定位置合成目标数字。

特别地，如果没有对残局附加任何限制，称为**自由定式（free定式）**。

## 3.4 定式的分类

根据初始局面、限制条件和目标数字（残局难度）进行分类。具体见附录。

---

# 4、功能概览

软件主菜单（**MainMenu**）包含了多个功能界面，每个界面都有不同的功能模块。您可以通过主界面上的按钮快速访问这些模块。以下是软件各个功能界面的简要介绍：

## 4.1 MainMenu（主菜单）
软件启动后会进入主菜单（**MainMenu**），包含以下6个功能界面：

- **Game**：提供最基础的游戏功能和AI。
- **MiniGame**：提供各种改版的小游戏，挑战更高的难度。
- **Practise**：展示最优走法，帮助学习游戏技巧。
- **Test**：测试您对残局走法的掌握程度。
- **Settings**：全局设置、计算定式。
- **Help**：展示帮助文档，指导如何使用软件。

## 4.2 Settings（设置界面）
包括定式计算和更改全局设置

- **调整设置**：自定义游戏方块的颜色、出4的概率、动画效果等。
- **定式计算**：选择您想要计算的残局定式，指定保存路径，并设置相关的进阶参数。点击“BUILD”按钮，软件会开始计算并保存定式数据，计算过程可能需要一定时间，具体取决于残局的复杂度和计算机性能。

## 4.3 Game（游戏界面）
提供最基本的2048游戏功能

- **AI模块**：点击游戏界面中的“AI：ON”按钮，AI将自动进行游戏。需要注意的是，AI功能依赖于事先计算好的定式。因此，在启用AI之前，您必须先计算并保存好相关定式。
- **困难模式**：在游戏界面下方，您可以找到一个名为“Difficulty”的滑块，拉到最右边开启困难模式，游戏难度将大幅增加。

## 4.4 MiniGame（小游戏界面）
提供多种改版小游戏，难度较高，适合有挑战精神的玩家

- **游戏规则**：每个小游戏的具体玩法可根据界面提示进行尝试。
- **难度设置**：左下角有一个“HardMode”按钮，点击后可以进一步增大游戏难度，挑战自己的极限。

## 4.5 Practise（练习界面）
展示最优走法，学习游戏技巧

- **定式练习**：在此界面，您可以查看计算好的定式，即每个局面四种走法对应的成功率。通过学习最优走法，您可以提升自己的游戏技巧。
- **录像功能**：记录残局的最优走法，或播放别人录制的文件。

## 4.6 Test（测试界面）
测试界面帮助您检验自己对残局走法的掌握情况：

- **设置测试局面**：您可以选择要测试的残局和初始局面，进行练习、评估和复盘。
- **回放分析**：支持导入2048verse.com上的游戏回放，进行局面分析和策略评估。

---

# 5、快速入门

定式计算是使用AI模块、练习模块、测试模块等重要功能的前提，您需要先计算并保存一个**定式**。

## 5.1 计算定式
   - 打开软件并进入主界面。
   - 点击**设置（Settings）**。
   - 选择您想要计算的定式模式（例如：L3-512-0）。
   - 指定定式保存路径（例如：F:/L3_512_0）。
   - 点击**构建（Build）** 按钮，开始计算。

## 5.2 学习定式
   - 进入**练习（Practise）**
   - 在左上角菜单栏（pattern\target\position）选择刚刚计算的定式
   - 勾选**显示（Show）** 复选框查看成功率
   - 点击**默认（Default）** 以显示随机初始局面
   - 点击**演示（Demo）** 

## 5.3 掌握定式
   - 进入**测试（Test）**
   - 在左上角菜单栏选择刚刚计算的定式
   - 执行您认为最佳的走法（使用wasd或↑↓←→控制）
   - 查看右侧的实时分析
   - 点击**保存日志（Save Logs）**

---

# 6、进阶用法

## 6.1 定式计算参数及选项

### 定式计算参数说明

| 参数           | 含义                                |
|--------------|-----------------------------------|
| **pattern**  | 定式名称                              |
| **target**   | 目标数字                              |
| **position** | 目标数字要求合成的位置。<br/>仅个别定式支持，一般设为0即可。 |

### 定式计算进阶选项

| 按钮                                          | 功能           | 目的          |
|---------------------------------------------|--------------|-------------|
| **compress temp files**                     | 压缩所有中间文件     | 降低计算期间的磁盘占用 |
| **compress**                                | 压缩最终的book文件  | 降低最终磁盘占用    |
| **opt only**                                | 仅保留所有最优分支    | 降低最终磁盘占用    |
| **Remove boards with a success rate below** | 删除成功率低于阈值的局面 | 降低最终磁盘占用    |

**说明**：
- 以上所有选项均**不会**降低成功率的准确度。
- **"Remove boards with a success rate below"** 和 **"opt only"** 选项会导致某些局面（通常是不合理的）被删除，成功率显示为0，但**不会**影响其他有效数据。

### 高级算法选项
勾选 **Advanced Algo** 后，程序将启用高级算法。称局面上≥64且＜32k的数字为*大数*，≤32的数字为*小数*。在该算法中，不满足以下条件的局面将被剪枝：
- 考虑局面上的**大数组合**。除最小大数外，其余大数至多存在一个。若最小大数大于64，允许其最多同时存在两个；若最小大数为64，允许其最多同时存在3个。
举例说明，大数组合（4k 2k 512 128 128）（1k 512 256）（512 64 64 64）均合法；（4k 2k 512 128 128 128）（4k 2k 512 128 128 64）均不合法。
- 考虑局面上**所有小数之和**。超参 **SmallTileSumLimit** (stsl) 控制剪枝强度。要求小数字和≤stsl + 64；如果局面存在两个相同大数，要求小数字和≤stsl；如果局面存在3个64，要求小数字和≤stsl - 64。
- 单步合成限制。每次操作至多合出1个新大数。

由于该算法实现方式的不同，其相比于常规算法具有以下优势：
- **计算加速**：定式越大，计算速度越快。对于free10w、4442ff即以上的大定式提速10倍以上。
- **内存优化**：计算过程中峰值内存占用降低1-2个数量级。因此内存受限的情况下，加速可达100倍以上。
- **存储效率**：中间文件占用的空间更小，定式越大节省空间越多；得到的book文件无需再进行压缩。

使用限制：
- 该算法专门设计用于计算超大定式，不适用于L3、T等小定式（性能可能更差）。
- 剪枝会降低成功率精确度。局面越偏离最优解、所处残局难度越高、定式固有限制越严格，成功率损失越大。一般来说成功率损失在万分之一以内，不影响最优路径。
- 不支持 **opt only**、 **compress** 选项。

借助该算法，目前已在9950x 128GB内存的计算机上成功计算free12w-2048，耗时约15天。

## 6.2 Practise 界面的各个按钮功能

### Practise 界面按钮功能

| 按钮                      | 功能                                                                                                                                         |
|-------------------------|--------------------------------------------------------------------------------------------------------------------------------------------|
| **set**                 | 重设局面为在左侧框中输入的值                                                                                                                             |
| **0-32k彩色数字按钮**         | 选中任意一个数字按钮进入设置局面模式。此时无法再操作局面移动，且成功率不再刷新，再次点击选中的数字退出设置模式。<br/>设置局面模式下，可以使用不同按键设置盘面数字： <br/>1、左键 - 改为按钮的数字 <br/>2、右键 - 增大一级 <br/>3、其他 - 减小一级 |
| **undo**                | 撤销上一步的操作                                                                                                                                   |
| **demo**                | 连续执行最优走法                                                                                                                                   |
| **onestep**             | 单次执行最优走法                                                                                                                                   |
| **default**             | 显示随机初始局面                                                                                                                                   |
| **UD/RL/R90/L90**       | 旋转和翻转                                                                                                                                      |
| **record demo**         | 录制并保存demo的走法和成功率                                                                                                                           |
| **load demo/play demo** | 加载和播放录制的文件                                                                                                                                 |
| **Manual**              | 手动模式，不再自动生成新数字。点击盘面，左键摆2，右键摆4                                                                                                              |
| **set...**              | 选择加载路径。**如果移动了计算好的定式文件，必须重新设置。**                                                                                                           |


## 6.3 Testing 界面进阶功能

可以**设置初始局面**。如果玩家不清楚局面编码方式，可以在practise界面摆放初始局面然后复制局面编码。

可以使用**分析Verse回放文件**按钮来解析在2048verse.com上的游戏回放记录，并生成详细的分析报告。

   - 将游戏回放写入txt文件并上传。
   - 选择需要分析的定式。你必须计算过该定式。
   - **如果移动了计算好的定式文件，必须在practise中重新设置路径。** 
   - 程序会解析回放中所有满足定式要求的残局，生成txt报告。

可以使用**回放复盘**按钮来复盘你在测验界面或者Verse上的进行的游戏回放记录。

   - 进入界面即可复盘刚刚进行的测验。
   - 界面中菜单栏左侧可以选择需要复盘的回放文件。
   - 分析Verse回放的同时也会生成回放文件。

---

# 7、关于AI

## 7.1 前置准备
为了充分发挥AI的性能，需要计算以下定式：
   - **free12w-2048**
   - **free11w-2048**
   - **4442f-2048**
   - **free11w-512**

请在运行AI之前确保以上定式能够在**Practise**界面正常加载。这些定式需要占用大量磁盘空间，为了尽可能降低所需空间，建议：
   - 对前三个定式设置较高的**成功率阈值（Remove boards with a success rate below）**，程序支持在计算过程中修改该参数以对不同的阶段设置不同的阈值。
   - 删除编号为目标数字/2之后的文件，例如删除free11w_2048_1024b~free11w_2048_1049b。
   - 启用高级算法。

## 7.2 AI测试
需要一定的编程知识。单独运行AItest.py，其中run_test函数将单次测试的游戏记录写入指定路径。
记录读取方式：
```
import numpy as np

rec=np.fromfile(r"C:\Users\Administrator\Desktop\record\0", dtype='uint64,uint32,uint8')

def decode(encoded_board: np.uint64) -> np.ndarray:
    encoded_board = np.uint64(encoded_board)
    board = np.zeros((4, 4), dtype=np.int32)
    for i in range(3, -1, -1):
        for j in range(3, -1, -1):
            encoded_num = (encoded_board >> np.uint64(4 * ((3 - i) * 4 + (3 - j)))) & np.uint64(0xF)
            if encoded_num > 0:
                board[i, j] = 2 ** encoded_num
            else:
                board[i, j] = 0
    return board

for board,score,operator in rec[:]:
    print()
    print(hex(board))
    print(decode(board))
    print({0:'AI',1:'free12',2:'free11_2k',3:'4442f',4:'free11_512'}[operator],'  ',score)
```

## 7.3 AI性能
目前最强的AI
-  不可撤销的情况下测试1200局，**65536 成功率 8.4% (±1.6%)，32768 成功率 86.1% (±2.0%)**。
   
     | search depth    | games | avg score  | median score | moves/s |
     |-----------------|-------|------------|--------------|---------|
     | 1~9 adaptive    | 1200  | 772353     | 819808       | 11      |

- 分段成功率

     | milestone     | success rate | comparable score |
     |---------------|--------------|------------------|
     | 8k            | 100%         | 97000            |
     | 16k           | 99.9%        | 210000           |
     | 32k           | 86.1%        | 453000           |
     | 32k+16k       | 72.8%        | 663000           |
     | 32k+16k+8k    | 61.8%        | 760000           |
     | 32k+16k+8k+4k | 53.3%        | 804000           |
     | final 2k      | 46.3%        | 824000           |
     | 65k           | 8.4%         | 971000           |


![survival rate](https://github.com/user-attachments/assets/8d708f06-4994-4878-8e27-2aa831db1a2b)



-  定式使用情况

     | Search | free12w-2k     | free11w-2k | 4442f-2k | free11w-512  |
     |--------|----------------|------------|----------|--------------|
     | 26.49% | 13.38%         | 1.41%      | 51.50%   | 7.22%        |


---

# 8、常见问题解答

### Q1: 为什么软件启动时需要较长时间？
**A1**: 启动后需要进行 JIT 编译（即时编译）。JIT 编译的目的是提高程序的运行效率，但这会导致第一次使用各个功能时需要较长的初始化时间。

### Q2: 定式文件的磁盘空间占用过大，如何优化？
**A2**: 考虑启用以下选项来减少磁盘占用：
1. **压缩中间文件**：此选项会压缩所有中间文件，减少计算过程中产生的磁盘占用。
2. **仅保留最优分支**：此选项会删除所有非最优的走法，只保留最优的分支，进一步减小存储空间。

### Q3: 计算过程中内存占用过高，如何解决？
**A3**: 定式计算时，内存占用较高是因为需要在计算过程中存储大量的局面数据。建议增加系统内存或设置虚拟内存。

### Q4: 定式计算是否支持断点重连？
**A4**: 是的，定式计算支持断点重连。对于不太熟悉程序计算逻辑和运行方式的用户，重连时建议保持所有选项和参数与之前一致。
对于经验丰富的用户，可以根据计算阶段调整部分参数，以实现更灵活的计算目的，包括压缩之前未压缩的定式文件等。

### Q5: 计算过程中报错如何处理？
**A5**: 如果在定式计算过程中遇到报错，请按照以下步骤进行处理：
1. **尝试断点重连**：关闭程序的所有窗口，重新启动程序并恢复计算。
2. **检查生成文件的大小变化趋势**：如果问题依然存在，检查最近生成的文件的大小变化趋势是否合理。若文件大小异常，可能是文件损坏（例如内存频率不稳定造成数据异常）。
3. **删除最近生成的几个文件**：删除最近生成的几个文件后，再次尝试断点重连。
4. **查看报错日志**：如果问题依然存在，找到logger.txt文件查看报错日志。常见问题包括内存不足和磁盘空间不足。
5. **联系作者**：如果上述方法仍无法解决问题，建议联系作者，提供您计算的定式和遇到的具体情况。作者将帮助您进一步排查和解决问题。

### Q6: 计算过程中出现磁盘IO挂起，如何处理？
**A6**: 如果在计算过程中，特别是在使用外置硬盘时，出现任务挂起的现象（表现为计算停止且长时间没有进展，CPU 占用率很低、内存占用不变，且最近生成的文件大小为0），通常是由于硬盘没有正常写入数据。此时，您可以尝试手动唤起硬盘：
1. 手动将一个小文件拷贝到硬盘，这可以激活硬盘写入操作。
2. 如果问题持续存在，请检查外置硬盘的连接或更换连接方式，确保硬盘处于正常工作状态。

### Q7: 为什么AI的表现不如预期？
**A7**: 如果AI的表现不如预期，可能是由于以下原因：
1. **未计算定式**：AI功能依赖于事先计算好的定式文件。确保相关定式可用。
2. **定式文件路径改变**：移动定式文件后，必须在practise中重新设置路径。
3. **计算机性能不足**：如果计算机性能较低，AI搜索速度可能很慢，请耐心等待。

### Q8: 为什么盘面上的数字显示过大，导致棋盘变形？
**A8**: 字号受到显示器分辨率影响，进而影响了棋盘的布局。可以在设置中调整字号。

---

# 9、支持和反馈

## 9.1 获取支持

如果在使用软件过程中遇到任何问题，您可以通过以下方式获得技术支持：

**GitHub 提交 Issue**  

   - 如果遇到软件中的问题或错误，您可以访问[GitHub 项目页面](https://github.com/game-difficulty/2048EndgameTablebase)并提交 Issue。请详细描述您遇到的问题，提供任何可能帮助我们复现问题的信息（如定式名称、错误日志、操作步骤等）。

**加入社区**  

   - 加入2048在线社区，与其他用户互动，分享经验，讨论问题和解决方案。
   - **QQ群**：94064339  
   - **Discord 频道**：2048 Runs

## 9.2 提交反馈

**在 GitHub 上为项目添加星标**  

   - 如果您喜欢这个项目，或者觉得它对您有帮助，欢迎在[GitHub 项目页面](https://github.com/game-difficulty/2048EndgameTablebase)上为我们的项目点一个星标（Star）。

---

# 10、附录

## 10.1 常用定式名称说明

| 定式名称   | 空格数        | 名称含义                                   | 最终阵型    | 大数移动限制                    | 特别说明                                                                                        |
|--------|------------|----------------------------------------|---------|---------------------------|---------------------------------------------------------------------------------------------|
| 442    | 10格定式      | 每行空位数依次是4420                           | 层叠      | 可双边三列回传                   |                                                                                             |
| L3     | 10格定式      | 空位排布是最外层的L型+3格                         | 628,63L | 均不可移动                     | 支持位置参数【0,1,2】                                                                               |
| L3t    | 10格定式      | t表示允许更多回传                              | 628,63L | 可单列回传                     | 不支持位置参数                                                                                     |
| t      | 10格定式      | 空位排布类似T的形状                             | T阵      | 1x2部分可上下移动，<br/>2x2部分不可移动 |                                                                                             |
| 444    | 12格定式      | 每行空位数依次是4440                           | 层叠      | 均不可移动                     | 支持位置参数【0,1】                                                                                 |
| LL     | 12格定式      | 空位排布由最外层和次外层的两个L型组成                    | T阵为主    | 均不可移动                     | 支持位置参数【0,1】                                                                                 |
| 4431   | 12格定式      | 每行空位数依次是4431                           | 628,63L | 均不可移动                     |                                                                                             |
| 4432f  | 12格定式      | f表示另外存在一个可自由移动的游离大数                    | T阵为主    | 角落三大数不可移动，<br/>游离大数无限制    | 4442f同理                                                                                     |
| 4432   | 13格定式      | 每行空位数依次是4432                           | T阵为主    | 均不可移动                     | 其他未提及的纯数字定式可参考这种命名方式                                                                        |
| 4441   | 13格定式      | 每行空位数依次是4441                           | 628,63L | 均不可移动                     |                                                                                             |
| free9w | 9格定式       | 全程9格自由定式                               |         | 无限制                       | 其他全程自由定式同理                                                                                  |                                      |
| free9  | 9格定式       | 半程10格自由定式。<br/>free9-n等价于后半程free10w-2n |         | 无限制                       | 举例：free9-256：<br/>初始局面包含6个大数和一个256，<br/>需要利用剩余的9个空位合出另一个256，<br/>并与现有的256合并。<br/>其他半程自由定式同理 |
| 3x3    | 9格定式(变体游戏) | 3x3变体，初始局面中只有一个2                       |         | 无限制                       | 2x4 3x4同理                                                                                   |

| 定式名称   | 初始局面示例                                                                 |
|--------|------------------------------------------------------------------------|
| 442    | ```_ _ _ _ ```<br/>```_ _ _ _ ```<br/>```_ _ x x ```<br/>```x x x x``` |
| L3     | ```_ _ _ _ ```<br/>```_ _ _ _ ```<br/>```_ x x x ```<br/>```_ x x x``` |
| L3t    | ```_ _ _ _ ```<br/>```_ _ _ _ ```<br/>```_ x x x ```<br/>```_ x x x``` |
| t      | ```_ _ _ _ ```<br/>```_ _ _ _ ```<br/>```x _ x x ```<br/>```x _ x x``` |
| 444    | ```_ _ _ _ ```<br/>```_ _ _ _ ```<br/>```_ _ _ _ ```<br/>```x x x x``` |
| LL     | ```_ _ _ _ ```<br/>```_ _ _ _ ```<br/>```_ _ x x ```<br/>```_ _ x x``` |
| 4431   | ```_ _ _ _ ```<br/>```_ _ _ _ ```<br/>```_ _ _ x ```<br/>```_ x x x``` |
| 4432f  | ```_ _ _ _ ```<br/>```_ _ _ _ ```<br/>```_ _ _ x ```<br/>```x _ x x``` |
| 4432   | ```_ _ _ _ ```<br/>```_ _ _ _ ```<br/>```_ _ _ x ```<br/>```_ _ x x``` |
| 4441   | ```_ _ _ _ ```<br/>```_ _ _ _ ```<br/>```_ _ _ _ ```<br/>```_ x x x``` |
| free9w | 大数任意排布                                                                 |
| free9  | 大数任意排布                                                                 |
| 3x3    | ```_ _ _ ```<br/>```_ _ 2 ```<br/>```_ _ _```                          |

## 10.2 定式大小参考

| Formation    | ~Size  | ~Compressed |
|--------------|--------|-------------|
| LL_4096_0    | 1.1 TB | 450 GB      |
| 4431_2048    | 650 GB | 250 GB      |
| 444_2048     | 130 GB | 60 GB       |
| t_512        | 2.5 GB | 1 GB        |
| L3_512_0     | 2 GB   | 1 GB        |
| 442_512      | 2 GB   | 1 GB        |
| 4432_512     | 250 GB | 100 GB      |
| 4441_512     | 800 GB | 330 GB      |
| 4432f_2048   | 3.5 TB | 1.33 TB     |
| free9_256    | 460 GB | 170 GB      |
| free10w_1024 | 2 TB   | 700 GB      |
